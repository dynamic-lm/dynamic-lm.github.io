<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Coding & Math Review</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <style>
    body { margin: 0; font-family: "Inter", Arial, sans-serif; background: #eef2f7; color: #1c1c1c; }
    .wrapper { max-width: 1280px; margin: 32px auto; background: #fff; border-radius: 14px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); overflow: hidden; }
    .header { padding: 12px 20px; background: linear-gradient(135deg, #1f3c88, #111827); color: #fff; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 0.95rem; font-weight: 600; max-width: 75%; letter-spacing: 0.01em; }
    .header button { background: rgba(255,255,255,0.92); color: #111827; border: none; padding: 9px 18px; border-radius: 999px; font-weight: 600; cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; }
    .header button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(255,255,255,0.35); }
    .header h1 a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px solid rgba(255,255,255,0.35);
      transition: color 0.15s ease, border-bottom-color 0.15s ease;
    }
    .header h1 a:hover {
      color: #bfdbfe;
      border-bottom-color: rgba(191, 219, 254, 0.75);
    }
    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header-actions .button-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255,255,255,0.12);
      color: #fff;
      border-radius: 999px;
      padding: 9px 18px;
      font-weight: 600;
      font-size: 0.9rem;
      text-decoration: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    .header-actions .button-link:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      background: rgba(255,255,255,0.18);
    }
    .question-details { 
      position: relative;
      padding: 18px 24px 40px; 
      border-bottom: 1px solid #e5e7eb; 
      display: block; 
      background: #f8fafc;
      line-height: 1.55;
      overflow: hidden;
      max-height: calc(1.35em * 3 + 1.55em * 2 + 72px);
    }
    .question-preview-title {
      margin: 0 0 0.15rem;
      font-size: 1.05rem;
      font-weight: 600;
      color: #0f172a;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .question-preview-title a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px solid rgba(15, 23, 42, 0.2);
      transition: border-bottom-color 0.2s ease;
    }
    .question-preview-title a:hover {
      border-bottom-color: rgba(15, 23, 42, 0.6);
    }
    .question-details::after {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 26px;
      background: linear-gradient(180deg, rgba(248, 250, 252, 0) 0%, #f8fafc 90%);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .question-details .question-content {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.55;
      min-height: calc(1.55em * 2);
      font-size: 0.98rem;
      margin-bottom: 4px;
    }
    .question-details .question-content > * {
      display: inline;
      margin: 0;
    }
    .question-details .question-content p + p::before {
      content: " ";
    }
    .question-details .view-full-context-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      position: static;
      background: none;
      color: #1d4ed8;
      border: none;
      border-radius: 0;
      padding: 4px 0;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      opacity: 1;
      pointer-events: auto;
      transition: color 0.2s ease, transform 0.2s ease;
      transform: translateY(0);
      box-shadow: none;
    }
    .question-details .view-full-context-btn:hover,
    .question-details .view-full-context-btn:focus-visible {
      transform: translateY(0);
      color: #0b3b9c;
    }
    .question-details .view-full-context-btn:focus-visible {
      outline: 2px solid rgba(59, 130, 246, 0.4);
      outline-offset: 2px;
    }
    .question-details.is-clamped::after {
      opacity: 1;
    }
    .math-answer-block,
    .code-answer-block { display: flex; flex-direction: column; gap: 8px; }
    .model-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .model-header img { width: 36px; height: 36px; object-fit: contain; border-radius: 8px; background: #fff; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12); }
    .answer-line-count {
      margin: 0 0 6px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #1d4ed8;
    }
    .view-reasoning-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: none;
      color: #1d4ed8;
      border: none;
      font-weight: 600;
      padding: 4px 0;
      cursor: pointer;
      font-size: 0.85rem;
      margin-bottom: 6px;
    }
    .view-reasoning-btn:hover,
    .view-reasoning-btn:focus-visible {
      color: #0b3b9c;
    }
    .control-bar { padding: 20px 28px; display: flex; flex-wrap: wrap; gap: 16px; align-items: center; border-bottom: 1px solid #e5e7eb; }
    .control-bar button { background: #2563eb; color: #fff; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background 0.15s ease; }
    .control-bar button:hover { background: #1d4ed8; }
    .model-selection { display: flex; flex-wrap: wrap; gap: 10px; }
    .model-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 999px; background: #f9fafb; cursor: pointer; transition: border-color 0.15s ease, background 0.15s ease; }
    .model-checkbox input { accent-color: #2563eb; cursor: pointer; }
    .model-checkbox:hover { border-color: #2563eb; background: #f3f4ff; }
    .panels-container { padding: 24px 28px 32px; display: flex; flex-direction: column; gap: 28px; }
    .model-block { border: 1px solid #e5e7eb; border-radius: 14px; padding: 22px; background: #fbfcfe; display: flex; flex-direction: column; gap: 20px; }
    .model-block h2 { margin: 0; font-size: 1.05rem; font-weight: 600; color: #0f172a; }
    .model-block h2 a {
      color: inherit;
      text-decoration: none;
      border-bottom: 1px solid rgba(37, 99, 235, 0.35);
      transition: color 0.15s ease, border-bottom-color 0.15s ease;
    }
    .model-block h2 a:hover {
      color: #2563eb;
      border-bottom-color: rgba(37, 99, 235, 0.8);
    }
    .model-panels { display: grid; gap: 22px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .panel { border: 1px solid #dbe3f4; border-radius: 12px; padding: 18px; display: flex; flex-direction: column; gap: 14px; background: #fff; min-height: 300px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.4); }
    .panel h3 { margin: 0; font-size: 0.95rem; color: #1f2937; }
    .math-answer, .final-answer { border-radius: 10px; line-height: 1.6; max-height: 180px; overflow-y: auto; }
    .math-answer { background: #f1f5f9; border-left: 4px solid #0ea5e9; padding: 12px 16px; }
    .final-answer { background: #e0f2fe; border-left: 4px solid #0284c7; padding: 12px 14px; font-weight: 600; color: #0f172a; }
    pre { margin: 0; border-radius: 10px; overflow: auto; max-height: 260px; }
    pre.code-block {
      display: grid;
      grid-template-columns: auto 1fr;
      padding: 0;
      background: #2d333b;
      border: 1px solid #444c56;
    }
    pre.code-block code {
      display: block;
      font-size: 0.9rem;
      line-height: 1.45;
      padding: 12px 16px;
      min-width: 0;
      white-space: pre;
    }
    pre.code-block .line-numbers {
      display: inline-flex;
      flex-direction: column;
      align-items: flex-end;
      padding: 12px 12px 12px 16px;
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.45;
      color: #9ca3af;
      background: rgba(15, 23, 42, 0.6);
      border-right: 1px solid rgba(148, 163, 184, 0.35);
      user-select: none;
      min-width: 3ch;
    }
    pre.code-block .line-numbers span {
      display: block;
    }
    .inline-code {
      font-family: "JetBrains Mono", "Fira Code", Consolas, monospace;
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      border-radius: 6px;
      padding: 0.1rem 0.35rem;
      font-size: 0.92em;
      white-space: pre;
    }
    .empty-state { text-align: center; padding: 40px; border: 1px dashed #cbd5f5; border-radius: 12px; color: #64748b; background: #f8fafc; }
  </style>
  <script>
    window.MathJax = { tex: { inlineMath: [["\\(","\\)"], ["$","$"]] }, svg: { fontCache: "global" } };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
</head>
<body>
  <div class="wrapper">
    <div class="header">
      <h1 id="question-title">Examples of Reasoning Leakage</h1>
      <div class="header-actions">
        <button id="next-problem" title="Cycle through the next problem">Next problem ▶</button>
      </div>
    </div>
    <div class="question-details" id="question-details"></div>

    <div class="control-bar">
      <div class="model-selection" id="model-selection"></div>
    </div>

    <div class="panels-container" id="panels-container"></div>
  </div>

  <script>
    let problems = [];
    let currentProblemIndex = 0;

    const questionTitleEl = document.getElementById("question-title");
    const questionDetailsEl = document.getElementById("question-details");
    const modelSelectionEl = document.getElementById("model-selection");
    const panelsContainerEl = document.getElementById("panels-container");
    const nextProblemBtn = document.getElementById("next-problem");
    const HEADER_TITLE = "Examples of Reasoning Leakage";
    questionTitleEl.textContent = HEADER_TITLE;

    function escapeHTML(str = "") {
      return String(str).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function escapeAttribute(str = "") {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function truncate(text = "", limit = 96) {
      const base = String(text);
      return base.length > limit ? base.slice(0, limit).trim() + "…" : base;
    }

    function slugify(text = "model") {
      return String(text).toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/^-+|-+$/g, "") || "model";
    }

    function formatPlainText(value = "") {
      const tokens = tokenizePlainText(String(value));
      return tokens.map(renderPlainToken).join("");
    }

    function tokenizePlainText(input) {
      const tokens = [];
      let idx = 0;
      let buffer = "";

      const flushBuffer = () => {
        if (buffer) {
          tokens.push({ type: "text", content: buffer });
          buffer = "";
        }
      };

      while (idx < input.length) {
        if (input.startsWith("```", idx)) {
          const fenceEnd = input.indexOf("```", idx + 3);
          if (fenceEnd === -1) {
            buffer += input.slice(idx);
            break;
          }

          flushBuffer();

          let lang = "";
          let contentStart = idx + 3;
          const newlineIdx = input.indexOf("\n", idx + 3);
          if (newlineIdx !== -1 && newlineIdx < fenceEnd) {
            lang = input.slice(idx + 3, newlineIdx).trim();
            contentStart = newlineIdx + 1;
          }
          const content = input.slice(contentStart, fenceEnd);
          tokens.push({ type: "codeblock", lang, content });
          idx = fenceEnd + 3;
          continue;
        }

        if (input.startsWith("**", idx)) {
          const end = input.indexOf("**", idx + 2);
          if (end === -1) {
            buffer += input[idx];
            idx += 1;
          } else {
            flushBuffer();
            const content = input.slice(idx + 2, end);
            tokens.push({ type: "bold", content });
            idx = end + 2;
          }
          continue;
        }

        if (input[idx] === "`") {
          const end = input.indexOf("`", idx + 1);
          if (end === -1) {
            buffer += input[idx];
            idx += 1;
          } else {
            flushBuffer();
            const content = input.slice(idx + 1, end);
            tokens.push({ type: "inline", content });
            idx = end + 1;
          }
          continue;
        }

        buffer += input[idx];
        idx += 1;
      }

      if (idx >= input.length && buffer) {
        tokens.push({ type: "text", content: buffer });
      }

      return tokens;
    }

    function renderPlainToken(token) {
      switch (token.type) {
        case "text":
          return escapeHTML(token.content).replace(/\n/g, "<br>");
        case "bold":
          return `<strong>${formatPlainText(token.content)}</strong>`;
        case "inline": {
          const trimmed = token.content.trim();
          if (/^latex[:\s]/i.test(trimmed)) {
            const latexContent = trimmed.replace(/^latex[:\s]*/i, "");
            return wrapLatex(latexContent);
          }
          return `<code class="inline-code">${escapeHTML(token.content)}</code>`;
        }
        case "codeblock": {
          const lang = (token.lang || "").trim().toLowerCase();
          if (lang === "latex" || lang === "math" || lang === "tex") {
            return wrapLatex(token.content.trim());
          }
          const languageClass = lang ? `language-${escapeHTML(lang)}` : "language-plaintext";
          return `<pre class="code-block"><code class="${languageClass}">${escapeHTML(token.content)}</code></pre>`;
        }
        default:
          return "";
      }
    }

    function wrapLatex(value = "") {
      const trimmed = value.trim();
      if (!trimmed) return "";
      const needsBlock = trimmed.includes("\n") || trimmed.includes("\\begin");
      return needsBlock ? `<span class="mathjax-latex">\\[${trimmed}\\]</span>` : `<span class="mathjax-latex">\\(${trimmed}\\)</span>`;
    }

    function renderRich(content) {
      if (!content) return "";
      if (typeof content === "string") {
        return formatPlainText(content);
      }
      const format = content.format || "text";
      const value = content.value ?? "";
      if (!value) return "";
      if (format === "latex") return wrapLatex(String(value));
      if (format === "html") return String(value);
      return formatPlainText(value);
    }

   function normalizeContent(content, fallbackValue = "") {
     if (!content && !fallbackValue) {
       return null;
     }
     if (typeof content === "string") {
       return { format: "text", value: content };
     }
     if (content && typeof content === "object") {
       const value = content.value ?? fallbackValue;
       return { format: content.format || "text", value };
     }
     return { format: "text", value: fallbackValue };
   }

    function getContentString(raw, fallbackValue = "") {
      if (raw == null) {
        return fallbackValue;
      }
      if (typeof raw === "string") {
        return raw;
      }
      if (typeof raw === "object") {
        const value = raw.value ?? fallbackValue;
        return typeof value === "string" ? value : String(value ?? "");
      }
      return String(raw);
    }

    function countLines(text = "") {
      if (!text) return 0;
      const normalized = String(text).replace(/\r\n/g, "\n");
      let lines = normalized.split("\n").length;
      if (normalized.endsWith("\n")) {
        lines -= 1;
      }
      if (lines < 1) {
        lines = 1;
      }
      return lines;
    }

    function extractQuestion(problem) {
      const question = problem.question;
      const fallbackUrl = problem && typeof problem === "object" ? (problem.url || problem.href || null) : null;
      if (!question) {
        return { title: "Untitled Problem", content: null, url: fallbackUrl };
      }
      if (typeof question === "string") {
        return { title: question, content: { format: "text", value: question }, url: fallbackUrl };
      }
      const title = question.title || "Untitled Problem";
      const content = normalizeContent(question.content, title);
      const url = question.url || question.href || fallbackUrl || null;
      return { title, content, url };
    }

    async function loadProblems() {
      try {
        questionDetailsEl.innerHTML = "<p>Loading problem…</p>";
        panelsContainerEl.innerHTML = "";
        const response = await fetch("./interactive_examples_data.json", { cache: "no-cache" });
        if (!response.ok) {
          throw new Error(`Failed to load data (${response.status})`);
        }
        const payload = await response.json();
        problems = Array.isArray(payload.problems) ? payload.problems : [];
        if (!problems.length) {
          questionDetailsEl.innerHTML = "<p>No problems available.</p>";
          panelsContainerEl.innerHTML = '<div class="empty-state">Add entries to interactive_examples_data.json to get started.</div>';
          return;
        }
        currentProblemIndex = 0;
        renderProblem();
      } catch (error) {
        console.error(error);
        questionDetailsEl.innerHTML = `<p>Failed to load examples.</p>`;
        panelsContainerEl.innerHTML = `<div class="empty-state">Unable to load interactive_examples_data.json.<br>${escapeHTML(error.message)}</div>`;
      }
    }

    function renderProblem() {
      if (!problems.length) {
        return;
      }
      const problem = problems[currentProblemIndex];
      const { title, content, url: questionUrl } = extractQuestion(problem);
      const questionHTML = renderRich(content);
      const questionTitleMarkup = questionUrl
        ? `<a href="${escapeAttribute(questionUrl)}" target="_blank" rel="noopener">${escapeHTML(title)}</a>`
        : escapeHTML(title);
      questionTitleEl.textContent = HEADER_TITLE;
      const encodedQuestion = encodeURIComponent(questionHTML || "");
      questionDetailsEl.innerHTML = `
        <h2 class="question-preview-title">${questionTitleMarkup}</h2>
        <div class="question-content">${questionHTML}</div>
        <button 
          class="view-full-context-btn" 
          data-content="${encodedQuestion}"
          data-title="${encodeURIComponent(title)}">
          View Full Problem
        </button>
      `;
      questionDetailsEl.classList.remove("is-clamped");

      const viewFullContextBtn = questionDetailsEl.querySelector(".view-full-context-btn");
      const updateClampState = () => {
        const isOverflowing = Math.ceil(questionDetailsEl.scrollHeight - questionDetailsEl.clientHeight) > 4;
        questionDetailsEl.classList.toggle("is-clamped", isOverflowing);
      };

      typesetMath(questionDetailsEl);
      updateClampState();
      setTimeout(updateClampState, 200);
      setTimeout(updateClampState, 600);
      requestAnimationFrame(updateClampState);

      if (viewFullContextBtn) {
        viewFullContextBtn.addEventListener("click", (event) => {
          event.preventDefault();
          const contentValue = viewFullContextBtn.dataset.content || "";
          if (!contentValue) {
            return;
          }
          const decoded = decodeURIComponent(contentValue);
          const encodedTitle = viewFullContextBtn.dataset.title;
          const modalTitle = encodedTitle ? decodeURIComponent(encodedTitle) : title;
          const win = window.open("", "_blank", "noopener");
          if (!win) {
            return;
          }
          win.opener = null;
          win.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="utf-8">
              <title>${escapeHTML(modalTitle)}</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
              <style>
                body { font-family: "Inter", Arial, sans-serif; background: #eef2f7; color: #1c1c1c; margin: 0; padding: 32px; }
                main { max-width: 960px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 32px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); }
                h1 { margin-top: 0; font-size: 1.6rem; }
              </style>
              <script>
                window.MathJax = {
                  tex: {
                    inlineMath: [['$', '$'], ['\\(', '\\)']],
                    displayMath: [['$$', '$$'], ['\\[', '\\]']]
                  }
                };
              </script>
              <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
            </head>
            <body>
              <main>
                <h1>${escapeHTML(modalTitle)}</h1>
                <div>${decoded}</div>
              </main>
            </body>
            </html>
          `);
          win.document.close();
        });
      }

      const defaultSelection = renderModelSelection(problem);
      renderPanels(problem, defaultSelection);
    }
    function normalizeModels(problem) {
      if (!problem || typeof problem !== "object") {
        return [];
      }
      if (Array.isArray(problem.models)) {
        return problem.models;
      }
      if (problem.model && typeof problem.model === "object") {
        return [problem.model];
      }
      return [];
    }

    function renderModelSelection(problem) {
      modelSelectionEl.innerHTML = "";
      const names = [];
      const models = normalizeModels(problem);
      models.forEach((model, idx) => {
        const modelName = model.name || `Model ${idx + 1}`;
        names.push(modelName);
        const id = `${problem.id || "problem"}-${slugify(modelName)}-option`;
        const label = document.createElement("label");
        label.className = "model-checkbox";
        label.setAttribute("for", id);

        const input = document.createElement("input");
        input.type = "checkbox";
        input.id = id;
        input.value = modelName;
        input.checked = true;

        input.addEventListener("change", () => {
          const selected = Array.from(modelSelectionEl.querySelectorAll("input"))
            .filter(el => el.checked)
            .map(el => el.value);
          renderPanels(problem, selected);
        });

        const span = document.createElement("span");
        span.textContent = modelName;

        label.appendChild(input);
        label.appendChild(span);
        modelSelectionEl.appendChild(label);
      });
      return names;
    }

    function renderPanels(problem, selectedModelNames) {
      const models = normalizeModels(problem);
      const activeNames = Array.isArray(selectedModelNames) ? selectedModelNames : [];
      const entries = models.map((model, idx) => ({
        model,
        name: model.name || `Model ${idx + 1}`
      }));
      const selectedModels = entries.filter(entry => activeNames.includes(entry.name));
      const stageNames = ["oracle", "interrupt"];
      if (!selectedModels.length) {
        panelsContainerEl.innerHTML = '<div class="empty-state">Select at least one model to view its oracle and interrupt outputs.</div>';
        typesetMath();
        return;
      }

      panelsContainerEl.innerHTML = selectedModels.map((entry, idx) => {
        const { model, name: modelName } = entry;
        const baseId = `${problem.id || "problem"}-${slugify(modelName)}-${idx}`;
        const modelLink = model && typeof model === "object" ? (model.url || model.href || null) : null;
        const logoSrc = model.logo ? escapeAttribute(model.logo) : null;
        const modelHeading = modelLink
          ? `<a href="${escapeAttribute(modelLink)}" target="_blank" rel="noopener">${escapeHTML(modelName)}</a>`
          : escapeHTML(modelName);
        return `
          <div class="model-block">
            <div class="model-header">
              ${logoSrc ? `<img src="${logoSrc}" alt="${escapeAttribute(modelName)} logo">` : ""}
              <h2>${modelHeading}</h2>
            </div>
            <div class="model-panels">
              ${stageNames.map(stage => {
                const stageData = model[stage] || {};
                const renderedAnswer = stageData.answer ? renderRich(stageData.answer) : "";
                const renderedFinal = stageData.final ? renderRich(stageData.final) : "";
                const renderedReasoning = stageData.reasoning ? renderRich(stageData.reasoning) : "";
                const stageLabel = stageData.label || (stage === "oracle" ? "Full Thinking" : "Hard Interrupt @0.3");
                const codeLineCount = stageData.code ? countLines(stageData.code) : 0;
                const answerLineCount = stageData.answer ? countLines(getContentString(stageData.answer)) : 0;
                const codeLineLabel = codeLineCount > 0 ? `<p class="answer-line-count">Answer section: ${codeLineCount} LINES</p>` : "";
                const answerLineLabel = answerLineCount > 0 ? `<p class="answer-line-count">Answer section: ${answerLineCount} LINES</p>` : "";
                const reasoningSection = renderedReasoning ? `
                  <button class="view-reasoning-btn" data-content="${encodeURIComponent(renderedReasoning)}" data-title="Reasoning - ${stageLabel}">View reasoning</button>
                ` : "";
                const codeSection = stageData.code ? `
                  <div class="code-answer-block">
                    ${codeLineLabel}
                    <pre class="code-block"><code class="language-python">${escapeHTML(stageData.code)}</code></pre>
                  </div>` : "";
                const answerSection = stageData.answer ? `
                  <div class="math-answer-block">
                    ${answerLineLabel}
                    <div class="math-answer">${renderedAnswer}</div>
                  </div>` : "";
                const finalSection = stageData.final ? `<div class="final-answer">${renderedFinal}</div>` : "";
                const bodyLabel = stage === "oracle" ? "Oracle Output" : "Interrupt Output";
                return `
                  <section class="panel">
                    <h3>${bodyLabel} &mdash; ${stageLabel}</h3>
                    ${reasoningSection}
                    ${codeSection}
                    ${answerSection}
                    ${finalSection}
                  </section>
                `;
              }).join("")}
            </div>
          </div>
        `;
      }).join("");

      panelsContainerEl.querySelectorAll(".view-reasoning-btn").forEach(btn => {
        btn.addEventListener("click", (event) => {
          event.preventDefault();
          const encoded = btn.dataset.content || "";
          if (!encoded) return;
          const title = btn.dataset.title || "Reasoning";
          const decoded = decodeURIComponent(encoded);
          const win = window.open("", "_blank", "noopener");
          if (!win) return;
          win.opener = null;
          win.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
              <meta charset="utf-8">
              <title>${title}</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
              <style>
                body { font-family: "Inter", Arial, sans-serif; background: #eef2f7; color: #1c1c1c; margin: 0; padding: 32px; }
                main { max-width: 960px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 32px; box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12); }
                h1 { margin-top: 0; font-size: 1.6rem; }
              </style>
              <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
            </head>
            <body>
              <main>
                <h1>${title}</h1>
                <div>${decoded}</div>
              </main>
            </body>
            </html>
          `);
          win.document.close();
        });
      });

      panelsContainerEl.querySelectorAll("pre code").forEach(block => {
        hljs.highlightElement(block);
        applyLineNumbers(block);
      });

      typesetMath();
    }

    function applyLineNumbers(codeEl) {
      if (!codeEl || codeEl.dataset.lineNumbers === "true") {
        return;
      }

      const pre = codeEl.parentElement;
      if (!pre || !pre.classList.contains("code-block")) {
        return;
      }

      const rawText = (codeEl.textContent || "").replace(/\r\n/g, "\n");
      let totalLines = rawText.split("\n").length;

      if (rawText.endsWith("\n")) {
        totalLines -= 1;
      }

      if (totalLines < 1) {
        totalLines = 1;
      }

      const numbers = document.createElement("span");
      numbers.className = "line-numbers";
      numbers.setAttribute("aria-hidden", "true");

      const fragment = document.createDocumentFragment();
      for (let idx = 1; idx <= totalLines; idx += 1) {
        const marker = document.createElement("span");
        marker.textContent = idx;
        fragment.appendChild(marker);
      }

      numbers.appendChild(fragment);
      pre.insertBefore(numbers, codeEl);

      codeEl.dataset.lineNumbers = "true";
      pre.dataset.lineNumbers = "true";
    }

    function typesetMath(scope) {
      if (window.MathJax && window.MathJax.typesetPromise) {
        if (scope) {
          MathJax.typesetPromise([scope]);
        } else {
          MathJax.typesetPromise();
        }
      }
    }

    nextProblemBtn.addEventListener("click", () => {
      if (!problems.length) {
        return;
      }
      currentProblemIndex = (currentProblemIndex + 1) % problems.length;
      renderProblem();
    });

    window.addEventListener("load", () => {
      typesetMath();
      loadProblems();
    });
  </script>
</body>
</html>
